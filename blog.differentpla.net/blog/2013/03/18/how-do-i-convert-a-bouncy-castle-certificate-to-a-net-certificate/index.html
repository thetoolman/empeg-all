<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width initial-scale=1" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>How do I convert a Bouncy Castle Certificate to a .NET Certificate?</title>
<meta name="description" content="Jekyll sources for blog.differentpla.net">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"> 
<!-- theme is https://bootswatch.com/yeti/ -->
<link rel="stylesheet" href="../../../../../css/yeti/bootstrap.min.css">
<link rel="stylesheet" href="../../../../../css/yeti-custom.css">
<link rel="stylesheet" href="../../../../../css/site.css">

<link rel="canonical" href="index.html">
<link type="application/atom+xml" rel="alternate" href="../../../../../feed.xml" title="Roger's Blog" />
</head>


<body>

<div class="navbar navbar-inverse" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <ul class="nav navbar-nav navbar-left">
                <li><a class="navbar-brand" href="../../../../../index.html">Roger's Blog</a></li>
            </ul>
        </div>
    </div>
</div>



<div class="container">
    <div class="col-md-9">
    <article>
        <h1>How do I convert a Bouncy Castle Certificate to a .NET Certificate?</h1>
        <div class="details">
            <span class="created_at timeago" title="2013-03-18 19:57:54 +0000">2013-03-18 19:57:54 +0000</span>
        </div>
        <p></p>
        <p>In the last installment, we created a <em>Bouncy Castle</em> certificate. How do we now create a .NET <code class="highlighter-rouge">X509Certificate2</code> object?</p>

<p>The only reliable way I’ve found to do this is to create a <code class="highlighter-rouge">PKCS12</code> file. On Windows, these are more commonly known as <code class="highlighter-rouge">.PFX</code> files. This is based on a solution I found <a href="http://web.archive.org/web/20100504192226/http://www.fkollmann.de/v2/post/Creating-certificates-using-BouncyCastle.aspx">here</a>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var store = new Pkcs12Store();
</code></pre></div></div>

<p>Bouncy Castle uses an “alias” to associate the public key and private key within the container. Windows refers to this as the certificate “friendly name”. For this example, we’ll use the subject name.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>string friendlyName = certificate.SubjectDN.ToString();
</code></pre></div></div>

<p>We then need to add the certificate to the store.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var certificateEntry = new X509CertificateEntry(certificate);
store.SetCertificateEntry(friendlyName, certificateEntry);
</code></pre></div></div>

<p>Then we add the private key. It needs to have the same alias, and needs to be associated with the certificate entry that we just added.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>store.SetKeyEntry(friendlyName, new AsymmetricKeyEntry(subjectKeyPair.Private), new[] { certificateEntry });
</code></pre></div></div>

<p>Now we’ve got a <code class="highlighter-rouge">Pkcs12Store</code>, we can copy it to a stream. For this part, we need to specify a password:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const string password = "password";

var stream = new MemoryStream();
store.Save(stream, password.ToCharArray(), random);
</code></pre></div></div>

<p>With that stream, we have two options. We can write a <code class="highlighter-rouge">.PFX</code> file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>File.WriteAllBytes("foo.pfx", stream.ToArray());
</code></pre></div></div>

<p>Note that to import this file, you’ll need to specify the password.</p>

<p>Alternatively, at this point, you can convert it to a .NET <code class="highlighter-rouge">X509Certificate2</code> object.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var convertedCertificate =
    new X509Certificate2(
        stream.ToArray(), password,
        X509KeyStorageFlags.PersistKeySet | X509KeyStorageFlags.Exportable);
</code></pre></div></div>

<p>I’ll write something about what the flags mean later…</p>

<p>And you can import that directly into the Windows Certificate store, should you want to.</p>

    </article>
</div>
<div class="col-md-3">
    <ul class="nav series">
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
            <li><a href="../using-bouncy-castle-from-net/index.html">Using Bouncy Castle from .NET</a></li></li>
        
        
        
        
        
        
        
            <li class="active"><a href="index.html">How do I convert a Bouncy Castle Certificate to a .NET Certificate?</a></li>
        
        
        
        
        
            <li><a href="../../20/bouncy-castle-missing-certificate-attributes/index.html">Bouncy Castle - Missing Certificate Attributes</a></li></li>
        
        
        
        
        
            <li><a href="../../23/bouncy-castle-extended-key-usage/index.html">Bouncy Castle - Extended Key Usage</a></li></li>
        
        
        
        
        
            <li><a href="../../24/bouncy-castle-subject-alternative-names/index.html">Bouncy Castle - Subject Alternative Names</a></li></li>
        
        
        
        
        
            <li><a href="../../24/bouncy-castle-being-a-certificate-authority/index.html">Bouncy Castle - Being a Certificate Authority</a></li></li>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    </ul>
</div>

</div>

<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.4.0/jquery.timeago.min.js"></script>

<script type="text/javascript">
$(document).ready(function() {
        $('.timeago').timeago();
        $('div.body > h1, h2, h3, h4, h5, h6').each(function(i) {
            $(this).append(
            '<a class="anchorlink" title="Link to ' +
                $(this).text() + '" href="index.html#' + $(this).attr('id') + '"></a>');
            });
        });
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-40120477-1', 'auto');
  ga('send', 'pageview');

</script>
</body>

</html>
