<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width initial-scale=1" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>ShellExecute doesn't work for URLs when called from a multithreaded apartment</title>
<meta name="description" content="Jekyll sources for blog.differentpla.net">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"> 
<!-- theme is https://bootswatch.com/yeti/ -->
<link rel="stylesheet" href="../../../../../css/yeti/bootstrap.min.css">
<link rel="stylesheet" href="../../../../../css/yeti-custom.css">
<link rel="stylesheet" href="../../../../../css/site.css">

<link rel="canonical" href="index.html">
<link type="application/atom+xml" rel="alternate" href="../../../../../feed.xml" title="Roger's Blog" />
</head>


<body>

<div class="navbar navbar-inverse" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <ul class="nav navbar-nav navbar-left">
                <li><a class="navbar-brand" href="../../../../../index.html">Roger's Blog</a></li>
            </ul>
        </div>
    </div>
</div>



<div class="container">
    <article>
    <h1>ShellExecute doesn't work for URLs when called from a multithreaded apartment</h1>
    <div class="details">
        <span class="created_at timeago" title="2007-02-27 12:14:21 +0000">2007-02-27 12:14:21 +0000</span>
        
    </div>
    <p></p>
    <p>I’ve got a dialog box with a SysLink (WC_SYSLINK) control on it. When the user clicks on the link, it should open our website in the user’s default browser. In my test app, it works. In the production app, it doesn’t.</p>

<p>It turns out that the production app calls <code class="highlighter-rouge">CoInitialize(NULL, COINIT_MULTITHREADED)</code>, and the test app doesn’t.</p>

<p>ShellExecute doesn’t work from multithreaded apartments. At least, not on Windows XP or 2003. The same code appears to work fine on Vista.</p>

<p>See the following:</p>

<ul>
  <li><a href="http://msdn.microsoft.com/msdnmag/issues/05/03/CATWork/default.aspx">C++ At Work: Making Static Links Keyboard-Capable, Launching URLs from Your App</a></li>
  <li><a href="http://support.microsoft.com/kb/287087">INFO: Calling Shell Functions and Interfaces from a Multithreaded Apartment</a></li>
</ul>

<p>If you’ve not already initialized COM, then it works fine. If you call CoInitialize(NULL), then it works fine. It’s only multithreaded apartments that don’t work. Paul DiLascia’s article (the first link above) has the following workaround if you don’t care about the result code:</p>

<pre>LPCTSTR url = _T("www.microsoft.com");
CString args;
args.Format(_T("url.dll,FileProtocolHandler %s"), url);
ShellExecute(NULL, _T("open"), _T("rundll32.exe"), args);</pre>

</article>

</div>

<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.4.0/jquery.timeago.min.js"></script>

<script type="text/javascript">
$(document).ready(function() {
        $('.timeago').timeago();
        $('div.body > h1, h2, h3, h4, h5, h6').each(function(i) {
            $(this).append(
            '<a class="anchorlink" title="Link to ' +
                $(this).text() + '" href="index.html#' + $(this).attr('id') + '"></a>');
            });
        });
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-40120477-1', 'auto');
  ga('send', 'pageview');

</script>
</body>

</html>
