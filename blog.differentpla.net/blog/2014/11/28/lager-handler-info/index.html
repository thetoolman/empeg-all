<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width initial-scale=1" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Getting lager handler info</title>
<meta name="description" content="Jekyll sources for blog.differentpla.net">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"> 
<!-- theme is https://bootswatch.com/yeti/ -->
<link rel="stylesheet" href="../../../../../css/yeti/bootstrap.min.css">
<link rel="stylesheet" href="../../../../../css/yeti-custom.css">
<link rel="stylesheet" href="../../../../../css/site.css">

<link rel="canonical" href="index.html">
<link type="application/atom+xml" rel="alternate" href="../../../../../feed.xml" title="Roger's Blog" />
</head>


<body>

<div class="navbar navbar-inverse" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <ul class="nav navbar-nav navbar-left">
                <li><a class="navbar-brand" href="../../../../../index.html">Roger's Blog</a></li>
            </ul>
        </div>
    </div>
</div>



<div class="container">
    <article>
    <h1>Getting lager handler info</h1>
    <div class="details">
        <span class="created_at timeago" title="2014-11-28 11:08:49 +0000">2014-11-28 11:08:49 +0000</span>
        
        <span class="label label-default"><a href="../../../../../tag/erlang">erlang</a></span>
        
        <span class="label label-default"><a href="../../../../../tag/lager">lager</a></span>
        
    </div>
    <p></p>
    <p>We use <a href="https://github.com/basho/lager">lager</a> for our logging at <a href="http://www.electricimp.com">Electric Imp</a>.
This morning I had cause to <a href="../../../05/10/adding-lager-handlers-at-runtime/index.html">tweak the
configuration</a>
at runtime on one of our staging boxes, but first I needed to figure out which
handlers were already installed.</p>

<p><strong>The following was done on a dev box, for demonstration purposes. The
configuration is slightly different in production.</strong></p>

<h2 id="which_handlers">which_handlers</h2>

<p>Lager uses <code class="highlighter-rouge">gen_event</code> to distribute log events, so I started with:</p>

<figure class="highlight"><pre><code class="language-erlang" data-lang="erlang">    <span class="p">(</span><span class="n">imp_server</span><span class="p">@</span><span class="n">roger</span><span class="o">-</span><span class="n">pc</span><span class="p">)</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="nn">gen_event</span><span class="p">:</span><span class="nf">which_handlers</span><span class="p">(</span><span class="n">lager_event</span><span class="p">).</span>
    <span class="p">[</span><span class="n">lager_rabbitmq_backend</span><span class="p">,</span><span class="n">lager_folsom_backend</span><span class="p">,</span>
     <span class="p">{</span><span class="n">lager_syslog_backend</span><span class="p">,{</span><span class="s">"imp_server"</span><span class="p">,</span><span class="n">local7</span><span class="p">}},</span>
     <span class="p">{</span><span class="n">lager_file_backend</span><span class="p">,</span><span class="s">"log/console.log"</span><span class="p">},</span>
     <span class="p">{</span><span class="n">lager_file_backend</span><span class="p">,</span><span class="s">"log/error.log"</span><span class="p">},</span>
     <span class="n">lager_console_backend</span><span class="p">,</span><span class="n">lager_backend_throttle</span><span class="p">]</span></code></pre></figure>

<p>Here you can see that we have several different backends registered:</p>

<ul>
  <li>One that talks to RabbitMQ; we use this one to email errors to the back-end
team. If there’s a spike in the number of error emails, someone is
automatically paged to investigate. The emails are also regularly triaged to
see if they signify a bug.</li>
  <li>One that reports metrics to graphite (via folsom and folsomite).  Along with
all of the other metrics gathered, we find it useful to track warning and
error counts across each server.</li>
  <li>One that reports to syslog. We use syslog to ship everything back to a
central log server, making it easier to correlate events in one place. We’re
considering whether to replace this with logstash.</li>
  <li>Two for writing to local log files.</li>
  <li>The console backend.</li>
  <li>The default <code class="highlighter-rouge">lager_backend_throttle</code> handler.</li>
</ul>

<p>However, this doesn’t tell us anything about the handler configuration. For
that, we have to dig a little deeper.</p>

<h2 id="lager_event-state">lager_event state</h2>

<p>One option is to use <code class="highlighter-rouge">sys:get_state(lager_event)</code>, which queries the state of
the <code class="highlighter-rouge">lager_event</code> event manager. In our example, it looks something like the
following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(imp_server@roger-pc) 2&gt; sys:get_state(lager_event).
[{lager_rabbitmq_backend,false,
                         {state,{mask,15},
                                &lt;0.119.0&gt;,lager_rabbitmq_formatter,
                                [{process,"imp_server"},{environment,"development"}]}},
 {lager_folsom_backend,false,{state,imp_server,{mask,31}}},
</code></pre></div></div>

<p>…etc.</p>

<p>This shows the <em>state</em> of the event handlers, which is not necessarily the same
as the <em>initial configuration parameters</em>. It’s still useful, though.</p>

<h2 id="which_children">which_children</h2>

<p>More useful, however, is the realisation that lager event handlers <a href="../../07/erlang-sup-event/index.html">are
supervised</a>.
This means that the supervisor <em>must</em> have a copy of the original configuration
parameters – otherwise it couldn’t restart them properly.</p>

<p>Unfortunately, we can’t get hold of that information directly. What we can do
is recognise that <code class="highlighter-rouge">lager_handler_watcher_sup</code> supervises
<code class="highlighter-rouge">lager_handler_watcher</code> processes, and those, too, must have the original
configuration somewhere:</p>

<p>We can get hold of the watchers:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(imp_server@roger-pc) 3&gt; Watchers = supervisor:which_children(lager_handler_watcher_sup).
[{undefined,&lt;0.80.0&gt;,worker,[lager_handler_watcher]},
 {undefined,&lt;0.82.0&gt;,worker,[lager_handler_watcher]},
 {undefined,&lt;0.84.0&gt;,worker,[lager_handler_watcher]},
 {undefined,&lt;0.101.0&gt;,worker,[lager_handler_watcher]},
 {undefined,&lt;0.122.0&gt;,worker,[lager_handler_watcher]},
 {undefined,&lt;0.91.0&gt;,worker,[lager_handler_watcher]},
 {undefined,&lt;0.76.0&gt;,worker,[lager_handler_watcher]},
 {undefined,&lt;0.78.0&gt;,worker,[lager_handler_watcher]}]
</code></pre></div></div>

<p>And then we can inspect any one of those to get the original configuration:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(imp_server@roger-pc) 4&gt; sys:get_state(pid(0,91,0)).
{state,lager_folsom_backend,
       [imp_server,warning],
       lager_event}
</code></pre></div></div>

<p>And there’s the backend and configuration:
<code class="highlighter-rouge">lager_folsom_backend,[imp_server,warning]</code>. Note that this relies on the
internal state of <code class="highlighter-rouge">lager_handler_watcher</code>, which might change.</p>

<p>We can make this prettier by use of the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[begin
    {state, Module, Config, Event} = sys:get_state(Pid),
    {Event, Module, Config}
 end || {_, Pid, _, _} &lt;- supervisor:which_children(lager_handler_watcher_sup)].
</code></pre></div></div>

<p>This outputs something like the following (I’ve ellided some of the details):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[{lager_event,{lager_file_backend,"log/error.log"}, ...},
 {lager_event,{lager_file_backend,"log/console.log"}, ...},
 {lager_event,{lager_syslog_backend,{"imp_server",local7}}, ...},
 {lager_event,lager_rabbitmq_backend, ...},
 {error_logger,error_logger_lager_h,[500]},
 {lager_event,lager_folsom_backend,[imp_server,warning]},
 {lager_event,lager_backend_throttle,[20,5]},
 {lager_event,lager_console_backend,
              [info,{lager_imp_formatter,[]}]}]
</code></pre></div></div>

<p>Of interest here is that you can see all of our backends, with configuration,
but also <code class="highlighter-rouge">error_logger_lager_h</code>, which is responsible for turning
<code class="highlighter-rouge">error_logger</code> events into <code class="highlighter-rouge">lager_event</code> events; and also the configuration for
<code class="highlighter-rouge">lager_backend_throttle</code>, which controls when it starts exerting back pressure.</p>

<p>Awesome. We’re done.</p>


</article>

</div>

<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.4.0/jquery.timeago.min.js"></script>

<script type="text/javascript">
$(document).ready(function() {
        $('.timeago').timeago();
        $('div.body > h1, h2, h3, h4, h5, h6').each(function(i) {
            $(this).append(
            '<a class="anchorlink" title="Link to ' +
                $(this).text() + '" href="index.html#' + $(this).attr('id') + '"></a>');
            });
        });
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-40120477-1', 'auto');
  ga('send', 'pageview');

</script>
</body>

</html>
